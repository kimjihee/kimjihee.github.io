<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>suicide rate</title>
    <style>
        @import url(http://fonts.googleapis.com/earlyaccess/nanumgothiccoding.css);
		body {
			font-family: 'Roboto', sans-serif;
			font-size:0.4rem;

		}   
		#chart {
			position: absolute;
			top:2rem;
			left:3.2rem;
			right:10vw;
			height:550px;
		}
		.axis path, .axis line {
			fill: none;
			stroke: rgba(100,100,100,0.4);
			shape-rendering: crispEdges;
		}
		.axis text {
		   fill:rgba(150,150,150,0.7); 
		} 
		p{
			font-size:2.5rem !important;
			position: absolute;
			top:2rem;
			left:6.7rem;
		}
		.tick {display:none;}
		.number {font-size:1rem;}
		.inRect {border:1px solid red !important;}
		.timePath {
			fill:none;
			stroke:black;
			stroke-width:0.5px;
		}
      </style>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    
    <script src="d3.min.js" type="text/javascript"></script></head>
    <body>
        <p>Suicide Rates<span class="number">&nbsp;&nbsp; Per 100,000 persons</span></p>
        <svg id="chart"> </svg>
       
        <script>

//----------------------------------------Data---------------------------------------------
        var dataSet = [];
        var yearExtent = [];
        var valueExtent = [];
//        var Female = [];
//        var Male = [];
        d3.csv('data/suicide_rate.csv', function (err, suicide) {
            suicide.forEach(function (row) {
                row['ReferenceArea'] = row['ReferenceArea'];
                row['TimePeriod'] = +row['TimePeriod'];
                row['Sex'] = row['Sex'];
                row['Value'] = +row['Value'];
            });
            
            var myCountries = [
                'United States','United Kingdom','China','Denmark',
                'Germany','India','Korea','Italy','France','Japan',
                'Greece','Sweden','Russian Federation','Mexico','Brazil',"Canada"
            ];
            var pickCountries = suicide.filter(function (row) {
                for(var i = 0; i < myCountries.length; i++) {
                    if(row['ReferenceArea'] === myCountries[i]) return true;
                }
                return false;
            });
     
            yearExtent = d3.extent(pickCountries, function(d) {return d.TimePeriod;});
            valueExtent = [0, d3.max(pickCountries, function(d) {return d.Value;})];

            var nest = d3.nest()
            .key(function(d){
            return d.ReferenceArea;
            })
		 	.key(function(d){
                return d.Sex;
            })
            .entries(pickCountries);
 
            dataSet = nest;
           	console.log(dataSet);
            
            redraw();    
        }); 
             
            var redraw = function(){
                  
            var MARGIN = {
                  TOP: 40
                , LEFT: 60
                , RIGHT: 100
                , BOTTOM: 0
            , }
 
            var padding = 20;
            var Width = 1150;
            var Height = 500;
////----------------------------------------column----------------------------------------
            d3.select('#chart')
                .attr('height',Height + 100);
				
			var columnSel = d3.select('#chart')
                .attr("width", Width+100)
                .attr("height", Height+200)
                .selectAll('g.column').data(dataSet);

            columnSel.enter()
                .append('g')
                .attr('class', function (d) {
                    return 'column ' + d.key;
                });
                    
            columnSel.exit().remove();
            columnSel.attr('transform', function (d,i) {
                return 'translate(' + ( Math.floor(i%9)* (Width/9) + MARGIN.LEFT )+ ', '+ ((Height/2)* Math.floor(i/9) +  MARGIN.TOP  )+ ')';
            });
                        
            var xScale = d3.scale.linear()
                .domain(yearExtent)
                .rangeRound([padding*1.5, (Width/9) - padding*1.5]);
            var yScale = d3.scale.linear()
                .domain(valueExtent)
                .rangeRound([(Height/2) - padding*2 , padding*2]);

            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom')
//                .ticks(d3.time.year)
                .tickValues(yearExtent)
//                .tickFormat(d3.time.format('%Y'))
                .tickSize(0)
                .tickPadding(8);
//            
//            var yAxis = d3.svg.axis()
//                .scale(yScale)
//                .orient('right')
//                .tickValues([10,30,50,70])
//                .tickPadding(10)
//                .tickSize(0); 
            
          columnSel
                .append('g')
                .attr('class', 'axis x')
                .attr("transform", "translate(  "+ - (padding) +" ," + yScale.range()[0] + ")")
                .style('stroke-width','1')
                .style('fill','rgba(240,240,240,0.5)') 
                .call(xAxis)
                .append("text")
                .attr("y", 15)
                .attr("x", padding+10)
                .style("text-anchor", "start")
                .style("font-weight", "bold")
                .style('fill','rgba(0,0,0,0.8)')
                .style('font-size','0.8rem')
                .text(function (d){return d.key; });
//         
//            d3.select('g.Germany')
//                .append('g')
//                .attr('class', 'axis y')
//                .attr("transform", "translate(  "+ 100 +" ,0)")
//                .style('stroke-width','0')
//                .style('color','rgb(200,200,200)')
//                .call(yAxis);  

            var dataLine = d3.svg.line()
                    .x(function(d) { return xScale(d.TimePeriod);})
                    .y(function(d) { return yScale(d.Value);})
                    .interpolate("monotone");  

            var dataSel = columnSel.selectAll('path.data').data(function(d){
                return [d.values[0], d.values[1]];
            });
            
			var color = d3.scale.ordinal()
                .domain(['Female', 'Male'])
                .range(['#de7766','#8a929e']);

            dataSel.enter()
                .append('path')
                .attr('class', function(d) {return 'data ' + d.key;})
                .attr("transform", "translate(  "+ - (padding) +" ,0)")
                .attr('stroke-linecap',"round")
                .style('fill',"none")
                .style('stroke',function(d) {return color(d.key);})
               	.style('opacity',0.9)
                .style('stroke-width',"2.5px")
                .attr('d', function(d) {
                    return dataLine(d.values);
                });
				
            dataSel.exit().remove();
            
            var textSel = columnSel.selectAll('g.inRect').data(function(d){
                return [d.values[0], d.values[1]];
            });        
            
            textSel.enter().append('g')
                .attr('width',120)
                .attr('height',80)
                .style('fill','none')
                .attr('class','inRect')
                .attr('x',-20)
                .attr('y',20);
                               
            var Text = textSel
                .selectAll('text.number')
                .data(function(d){return d.values});   
            
            Text.enter()
                .append("text")
                .attr("class", "number")
                .attr("transform","translate(" + (-padding) + " ,-5)")
				.attr('text-anchor', function(d, i) {
					return i === 0 ? 'start' : 'end';
				})
				.attr('alignment-baseline', 'baseline')
                .attr("x",function(d) { return xScale(d.TimePeriod); })
                .attr("y",function(d) { return yScale(d.Value);})            
                .attr('fill','black')
                .attr('opacity',0.8)
                .style('font-size','0.4rem')
                .text(function(d){return d.Value.toFixed();});  
				
			var timePath = d3.select('#chart')
				.append('g')
				.attr('width',100)
				.attr('height',40)
				.attr('x',916)
				.attr('y',78)
				.attr('transform','translate(38,295)');
				
//			timePath
//				.append('path')
//				.attr('class','timePath')
//				.attr('d','M 30 0 V 0 H 95 V 0')
//				.attr('stroke','black');
				
			timePath
				.append('text')
				.attr('x',20)
				.attr('y',-10)
				.attr('fill','rgb(139,139,139)')
				.text(yearExtent[0]);
				
			timePath
				.append('text')
				.attr('x',85)
				.attr('y',-10)
				.attr('fill','rgb(139,139,139)')
				.text(yearExtent[1]);

//            Text.enter()
//                .append("circle")
//                .attr("class", "number circle")
//                .attr("transform","translate(  "+ - (padding) +" ,0)")
//                .attr("cx",function(d) { return xScale(d.TimePeriod); })
//                .attr("cy",function(d) { return yScale(d.Value);})            
//                .attr('fill',function(d){return color(d.key);})
//                .attr('r',2);
            
        };
            
                       
        </script>
    </body>
</html>