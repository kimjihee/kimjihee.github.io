<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>C02 Emission</title>
    <style>
        body {font-family: 'Roboto', sans-serif;}
        #chart {
            position: absolute;
            top:2rem;
            left:4rem;
            padding-top:2.5rem;
            font-size:0.4rem;

        }
                
        .axis path, .axis line {
            fill: none;
            stroke: rgba(100,100,100,0.4);
            shape-rendering: crispEdges;
        }
        .axis text {
           fill:rgba(100,100,100,0.85);
        } 
        
        
        div{padding-left:35px;}
        .text { 
            font-weight:bold;
            
            position: absolute;
            font-size:1.2rem;
            top: 1.5rem;}
        .context { 
            font-size:0.7rem;
            
            line-height:1.3rem;
            padding-left:40px;}
        .smallText { font-size: 0.8rem;
       }
        .designer {font-size:0.8rem;
        font-weight:normal;
            
        }
        .내이름 { color:#0080c3; }
         .unit {font-size:0.9rem;}
        p{
            font-size:1.7rem;
            position: absolute;
            top:3.5rem;
            left:6rem;
            font-weight:500;
        }
        .x text {text-anchor:start !important;}
      </style>
    
   <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <script src="d3.min.js" type="text/javascript"></script></head>
    <body>
        
         <p> CO2 Emission <span class="unit">Tons Per Capita</span></p> 
       
        
        <svg id="chart" > </svg>
        
        <script>
            

//--- Data---------------------------------------------
        var dataSet = [];
        var yearExtent = [];
        var valueExtent = [];
        
        var Emission = d3.csv('data/CO2emissions.csv', function (err, CO2) {
            CO2.forEach(function (row) {
                row['Country'] = row['Country'];
                row['Value'] = +row['Value']; 
                row['Year'] = new Date(+row['Year'], 0 ,1);
            });
            var myCountries = ['United States','United Kingdom','China','Denmark','Germany','India','Korea','Italy','France','Japan'];
            var pickCountries = CO2.filter(function (row) {
                for(var i = 0; i < myCountries.length; i++) {
                    if(row['Country'] === myCountries[i]) return true;
                }
                return false;
            });
            
            yearExtent = d3.extent(pickCountries, function(d) {return d.Year;});
            valueExtent = [0, d3.max(pickCountries, function(d) {return d.Value;})];
            
            dataSet = d3.nest()
                .key(function(d){
                    return d.Country;
                })
                .entries(pickCountries);
            redraw();           
       });     
        
            
     var redraw = function () {   
            
//  ------------------------------------------Draw------------------------------------------
                 
            var MARGIN = {
                  TOP: 0
                , LEFT: 50
                , RIGHT: 0
                , BOTTOM: 0
            , }
            
          
            var padding = 70;
            var Width = 1000;
            var Height = 600;
////----------------------------------------column----------------------------------------
            console.log(dataSet);
            var columnSel = d3.select('#chart')
                .attr("width", Width+50)
                .attr("height", Height-200)
                .selectAll('g.column').data(dataSet);

            columnSel.enter()
                .append('g')
                .attr('class', function (d) {
                    return 'column ' + " " + d.key;
                })
               ;
                    
            columnSel.exit().remove();
            columnSel.attr('transform', function (d,i) {
                return 'translate(' + ( Math.floor(i%5)* (Width/5) + MARGIN.LEFT )+ ', '+ ((Height/5)* Math.floor(i/5) +  MARGIN.TOP  )+ ')';
            });
                
//------------------------------------------One Graph----------------------------------------------       
            var xScale = d3.time.scale()
                .domain(yearExtent)
                .rangeRound([padding/2, (Width/4) - padding/0.8]);
            var yScale = d3.scale.linear()
                .domain(valueExtent)
                .rangeRound([(Height/3.4) - padding/10 , padding*1.8]);

            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom')
                .ticks(d3.time.year, 20)
                .tickFormat(d3.time.format('%Y'))
                .tickSize(0)
                .tickPadding(8);
            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left')
                .tickValues([5,10,20]) //원하는 숫자 넣을 수 있다.
                .tickSize(0) // 튀어나온 선의 크기
                .tickPadding(4); // 축과 글자 사이의 간격
         
            columnSel
                .append('g')
                .attr('class', 'axis x')
                .attr("transform", "translate(  "+ - (padding/2) +" ," + yScale.range()[0] + ")")
                .style('stroke-width','1')
                .call(xAxis)
                .append("text")
                .attr("y", -100)
                .attr("x", 15)
                .attr("dy", "3em") 
                .style("line-height", "-0.8rem")
                .style("font-size", "0.8rem")
                .style('font-weight','bold')
                .style('fill','black')
                .text(function (d){return d.key; });
         
            columnSel
                .append('g')
                .attr('class', 'axis y')
                .style("text-anchor", "middle")
                .call(yAxis)
                ;

            var lineCO2 = d3.svg.line()
                .x(function(d) { return xScale(d.Year); })
                .y(function(d) { return yScale(d.Value); })
                .interpolate("monotone");           
            columnSel
                .append('path')
                .attr('class', function (d) {
                    return 'data' + d.key;
                })
                .style('fill',"none")
                .style('z-index',"2")
                .style('stroke', "#6e8da6")
                .style('opacity', 1)
                .style('stroke-width',"1.8px")
                .attr("transform", "translate(  "+ - (padding/2) +" ,0 )")
                .attr('d', function(d) {
                    return lineCO2(d.values);//여기서 d는 dataSet은 아니고, dataSet[0] dataSet[1] ... 이다.  
                });
               
         
//           var circle = columnSel
//                .selectAll('circle.number')
//                .data(function(d){return d.values});   
//                
//            circle.enter()
//                .append("circle")
//                .attr('class', function (d) {
//                    return 'number' + d.Country +' '+ d.Year;
//                })
//                .attr("transform", "translate(  "+ - (padding/2) +" ,0)")
//                .attr("r", 3 )
//                .style('fill','#6e8da6')
//                .append("title")
//                  .text('9.52093176 Ton');
//            circle.exit()
//                .remove();
//            circle
//                .attr("cx", '144')
//                .attr("cy", '123'); 
////                .attr("cx", function(d) {return xScale(d.Year);})
////                .attr("cy", function(d) {return yScale(d.Value);}); 
         
         
          };
                    
            
//           var realChart = svg.select('g.column.a').selectAll('g').data(dataSet);
//                       
//            realChart.append('g')
//                .attr('class', 'x axis')
//                .attr("transform", "translate( 0 ," + height + ")")
//                .style('stroke-width','2')//축 두께
//                .call(xAxis);
//            
//           
//
//            realChart.append('g')
//              .attr('class', 'y axis')
//              .call(yAxis)
//              ;
//        
//           
//            var lineCO2 = d3.svg.line()
//                .x(function(d) { return xScale(d.Year);
//                                })
//                .y(function(d) { return yScale(d.Value); })
//                .interpolate("monotone");           
//            
//         
//         
//               realChart
//                .append("path")
//                .attr("d", lineCO2(dataSet[220].values)
//                )
//                .style('fill',"none")
//                .style('stroke',"green")
//                .style('opacity', 1)
//                .style('stroke-width',"1px")
//                ;
      
          
            // data binding을 하는것과 안하는것의 차이는 무엇인가???
            // 데이터 바인딩을 했을때 i는 어떻게 적용이 되는가? 계속 다 처음부터 끝까지?
            // 데이터를 가져올때 d를 쓰는것과 dataSet을 쓰는 것의 차이
            // dataSet.values; 또는 dataSet[0].values.Year 이렇게 햇을때 아무것도 안나오는 이유는?
            // d3 안에서 for은 어떻게 사용이 되는 것인가?
           

      
    
        </script>
</body>
</html>