<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Multi or Stack</title>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <script src="d3.min.js" type="text/javascript"></script>

    <style>
        body{
            width:1000px;
        }
        
        text {
            font: 10px sans-serif;
        }
        
        .group-label {
            font-weight: bold;
            text-anchor: end;
        }
        
        form {
            position: absolute;
            right: 12rem;
            top: 2rem;
        }
        
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
    </style>
    <form>
        <label>
            <input type="radio" name="mode" value="multiples" checked> Multiples</label>
        <label>
            <input type="radio" name="mode" value="stacked"> Stacked</label>
    </form>


</head>

<body>
    <svg id="chart"> </svg>
    
    <script>
        
  //---------------------------------------Layout---------------------------------- 

        var MARGIN = {
            TOP: 100,
            BOTTOM: 100,
            LEFT: 100,
            RIGHT: 0
        };


        var Width = 800;
        var Height = 400;
        
        
        //-------------------------------------Data-------------------------------------  
        
        

        
               
        var nest = d3.nest().key(function (d) {
            return d.group;
        });
        var dateFormat = d3.time.format('%Y-%m-%d');
        var dataSet = [];
        var multiStack = d3.csv('data/multistack.csv', function (err, swim) {
            swim.forEach(function (row) {

                row['group'] = +row['group'];
                row['date'] = dateFormat.parse(row['date']);
                row['value'] = +row['value'];
            })

            dataSet = swim;
            redraw();
                       
        });  

   //---------------------------------------Scale-----------------------------------        
        
        
        var redraw = function () {
            
            var xScale = d3.scale.ordinal()
                .rangeBands([0, Width - MARGIN.LEFT - MARGIN.RIGHT],0.2);


            var yScale = d3.scale.ordinal()
                           .rangeBands([Height - MARGIN.TOP - MARGIN.BOTTOM ,0.3]);
          

            var y0Scale = d3.scale.linear();
               
            
            var nest = d3.nest()
                .key(function(d) { return d.group; });

            var stack = d3.layout.stack()
                .values(function(d) { return d.values; })
                .x(function(d) { return d.date; })
                .y(function(d) { return d.value; })
                .out(function(d, y0) { d.valueOffset = y0; });
            

            var color = d3.scale.category10();

            var dataByGroup = nest.entries(dataSet);

              stack(dataByGroup);
              xScale.domain(dataByGroup[0].values.map(function(d) { return d.date; }));
              yScale.domain(dataByGroup.map(function(d) { return d.key; }));//key 값은 group
              y0Scale.domain([0,d3.max(dataSet, function(d) { return d.value; }) ]).range([yScale.rangeBand(),0]);

         
            console.log(dataByGroup);


            //------------------------------------Axis--------------------------------------------

            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom')
                .tickSize(2)
                .ticks(d3.time.date,1) //start stop //이렇게 1이 스탑인데 맞나요? 이게뭘까?
                .tickFormat(d3.time.format('%Y-%m'));


            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left')
                .tickSize(2)
                .tickFormat(function (d) {
                    return d + 'Km';
                });

            //---------------------------------call Axis------------------------------------------

            var svg = d3.select("svg")
                .attr("width", Width + MARGIN.LEFT + MARGIN.RIGHT)
                .attr("height", Height + MARGIN.TOP + MARGIN.BOTTOM);

            var realChart = svg
                .append('g')
                .attr('transform', 'translate(' + MARGIN.LEFT + ', ' + MARGIN.TOP + ')');

            realChart.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(0, ' + (Height - MARGIN.TOP - MARGIN.BOTTOM) + ')')
                .style('stroke-width', '1')
                .call(xAxis)
                .selectAll('text')
                .style('text-anchor', 'middle');

            realChart.append("g")
                .attr("class", "y axis")
                .style('stroke-width', '1')
                .call(yAxis);
            
            

            
//-------------------------------------draw-Graph------------------------------------------
            
            
            
              var group = svg.selectAll(".group")
                  .data(dataByGroup)
                  .enter()
              .append("g")
                  .attr("class", "group")
                  .attr("transform",'translate(' + MARGIN.LEFT + ', 0)')
                 ;

//              group.append("text")
//                  .attr("class", "group-label")
//                  .attr("x", -6)
//                  .attr("y", function(d) { return y0Scale(d.values[0].value / 2); })
//                  .attr("dy", ".35em")
//                  .text(function(d) { return "Group " + d.key; });

              group.selectAll("rect")
                  .data(function(d) { return d.values; })
                  .enter().append("rect")
                  .style("fill", function(d) { return color(d.group); })
                  .attr("x", function(d) { return xScale(d.date); })
                  .attr("y", function(d) { return y0Scale(d.value); })
                  .attr("width", xScale.rangeBand())
                  .attr("height", function(d) { return yScale.rangeBand() - y0Scale(d.value); });
//
//              group.filter(function(d, i) { return !i; }).append("g")
//                  .attr("class", "x axis")
//                  .attr('transform', "translate(0," + y0Scale.range() + ")")
//                  .call(xAxis);

              d3.selectAll("input").on("change", change);

              var timeout = setTimeout(function() {
                d3.select("input[value=\"stacked\"]").property("checked", true).each(change);
              }, 2000);

              function change() {
                clearTimeout(timeout);
                if (this.value === "multiples") transitionMultiples();
//                else transitionStacked();
              }

              function transitionMultiples() {
                var t = svg.transition().duration(750),
                    g = t.selectAll(".group").attr("transform", function(d) { return "translate(0," + + yScale(d.key) + ")"; });
                g.selectAll("rect").attr("y", function(d) { return y0Scale(d.value); });
                g.select(".group-label").attr("y", function(d) { return y0Scale(d.values[0].value / 2); })
              }

//              function transitionStacked() {
//                var t = svg.transition().duration(750),
//                    g = t.selectAll(".group").attr("transform", "translate(0," + yScale(yScale.domain()[0]) + ")");
//                g.selectAll("rect").attr("y", function(d) { return y0Scale(d.value + d.valueOffset); });
//                g.select(".group-label").attr("y", function(d) { return y0Scale(d.values[0].value / 2 + d.values[0].valueOffset); })
//              }

        
        
        
        };


         // redraw---------- 끝내기 http://bl.ocks.org/mbostock/4679202
    </script>

</body>

</html>