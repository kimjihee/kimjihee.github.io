<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Child labour</title>
    <style>
        #chart {
            border: 1px solid black;
                 }
        
/*
         
             var yBandSel = d3.select('#chart').selectAll('g.yBand').data(dataSet);  
             yBandSel.enter()
               .append('g')
                .attr('class', function (d,i) {
                return 'yband ' + i;
           })
            yBandSel.exit().remove();
           
            yBandSel
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
            .on("mouseover", function () {
                  d3.select(this).attr("fill-opacity", "1");
              })
               .on("mouseout", function () {
                   d3.select(this).attr("fill-opacity", "0.75");
               });
                 .attr('transform', function (d) {
               return 'translate(' + columnBand(d) + ', ' + MARGIN.TOP + ')'; //++의 정체는 무엇인가!!!
           });
*/
              
                
    </style>
    <script src="d3.min.js" type="text/javascript"></script>
</head>

<body>
    <svg id="chart" height="2400" width="1000"></svg>
    <script>
        var dataSet = [];
        // labour data
        d3.csv('data/Child_labour.csv', function (err, labour) {
            d3.csv('data/attendance_in_primary_education.csv', function (err, attend) {
                labour.forEach(function (row) {
                    row['Labour'] = +row['Value'];
                });
                var labourMale = labour.filter(function (row) {
                    return row['Subgroup'].startsWith('Male');
                });
                var labourFemale = labour.filter(function (row) {
                    return row['Subgroup'].startsWith('Female');
                });
                attend.forEach(function (row) {
                    row['Attend'] = +row['Value'];
                });
                var attendMale = attend.filter(function (row) {
                    return row['Subgroup'].startsWith('Male');
                });
                var attendFemale = attend.filter(function (row) {
                    return row['Subgroup'].startsWith('Female');
                });
                
                
//----------------------------------------CountryName----------------------------------------    
                
                var mergedDict = {};
                labourMale.forEach(function (row, i) {
                    var key = row['Country'];
                    mergedDict[key] = row;// 여긴 먼가 오른쪽 왼쪽이 바뀐느낌
                    mergedDict[key].LabourFemale = labourFemale[i].Labour;
                });
                attendMale.forEach(function (row, i) {
                    var key = row['Country'];
                    if (!mergedDict[key]) {
                        mergedDict[key] = row;// 교집합으로 하려면 어떻게?
                    }
                    else {
                        mergedDict[key]['Attend'] = row['Attend'];
                    }
                    mergedDict[key].AttendFemale = attendFemale[i].Attend;
                });
                var mergedData = [];
                for (var key in mergedDict) {
                    mergedData.push(mergedDict[key]);
                }
                
                
                //-----------------교집합을 하고 싶을때!!!!!!
//                mergedData = mergedData.filter(function(d) {
//                    return !(d.Labour === undefined || d.LabourFemale === undefined || d.Attend === undefined || d.AttendFemale === undefined);
//                });
                dataSet = mergedData;
                redraw();
            });
        });

//------------------------------------------Draw------------------------------------------
       
            var redraw = function () {
            var MARGIN = {
                START:0
                , TOP: 0
                , LEFT: 230
                , RIGHT: 0
                , BOTTOM: 0
            , }
            var Width = document.querySelector('#chart').clientWidth;
            var Height = document.querySelector('#chart').clientHeight;
                
            
//----------------------------------------column----------------------------------------
                
                
            var columnBand = d3.scale.ordinal()
            .domain(['ml', 'fl', 'me', 'fe'])
            .rangeRoundBands([MARGIN.LEFT, Width - MARGIN.RIGHT], 0.07);
            
                
            var yBand = d3.scale.ordinal()
            .domain(d3.range(dataSet.length))
            .rangeRoundBands([0, Height - MARGIN.TOP - MARGIN.BOTTOM], 0.12, 0.7);
            
                
            var columnSel = d3.select('#chart').selectAll('g.column').data(columnBand.domain());
            
            columnSel.enter()
                .append('g')
                .attr('class', function (d) {
                return 'column ' + d;
            })
//                .attr('fill', function (d) {
//                return 'rgb(' + (d.length) * 10 + ',30,30)';
//            })
            columnSel.exit().remove();
            
            columnSel.attr('transform', function (d) {
                return 'translate(' + columnBand(d) + ', ' + MARGIN.TOP + ')'; //++의 정체는 무엇인가!!!
            });
                
                
//-------------------------------------------Making-hover---------------------------------------------                
                
                
                
             var yBandSel = d3.select('#chart').selectAll('g.yBand').data(dataSet);  
             yBandSel.enter()
                .append('g')
                .attr('class', function (d,i) {
                return 'yband ' + i;
            })
             yBandSel.exit().remove();
             yBandSel
             .attr('transform', function (d,i) {
                return 'translate(' + MARGIN.START + ', ' + yBand(i) + ')'; //++의 정체는 무엇인가!!!
            })
            .on("mouseover", function () {
            d3.select(this).attr("background", 'grey')
                .attr('fill-opacity','0.4');
                })
                .on("mouseout", function () {
                    d3.select(this).attr("fill-opacity", "0");
                });
          
                
                
                
                
            
//---------------------------------------h2------------------------------------------------
                
                
                var themeName = ['Child Labour',"",'Non Attendance of Student']
                
                                 
                var themeSel = d3.select('#chart').selectAll('text.theme').data(columnBand.domain());
            themeSel.enter()
                .append('text')
                .attr('class', 'theme');
            themeSel.exit()
                .remove();
            themeSel
                .attr('transform', function (d) {
                    return 'translate(' + columnBand(d) + ',  '+40+' )';
                })
                .attr('text-anchor', 'start')
                .attr('font-size','1rem')
                .attr('fill', 'black')
                .attr('font-weight', 'bold')
                .text(function(d, i) {return themeName[i];});
                
                
//---------------------------------------- Labels------------------------------------------
                
            var labelSel = d3.select('#chart').selectAll('text.label').data(dataSet);
            labelSel.enter()
                .append('text')
                .attr('class', 'label');
            labelSel.exit()
                .remove();
            labelSel
                .attr('transform', function (d, i) {
                return 'translate(' + MARGIN.LEFT + ', ' + yBand(i) + ')';
            }).attr('text-anchor', 'end')
              .attr('font-size','0.8rem')
                .attr('fill', 'black')
                .attr('alignment-baseline', 'text-before-edge')
                .text(function (d) {
                return d.Country;
            });
                
//==========================================Gragh=================================================                                
          var mlNumbers = d3.select('g.column.ml').selectAll('text.mlNumber').data(dataSet);
                mlNumbers.enter()
            .append('text')
            .attr('class', 'mlNumber');
        mlNumbers.exit()
            .remove();
        mlNumbers
            .attr('x', function(d) {return ((d.Labour || 0)*0.01) * columnBand.rangeBand() + 6 ;})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return d.Labour||"no data"});
                
                
            //
                var flNumbers = d3.select('g.column.fl').selectAll('text.flNumber').data(dataSet);
                flNumbers.enter()
            .append('text')
            .attr('class', 'flNumber');
        flNumbers.exit()
            .remove();
        flNumbers
            .attr('x', function(d) {return ((d.LabourFemale || 0) *0.01) * columnBand.rangeBand() + 6 ;  })
            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return d.LabourFemale||"no data"});
                
                
                
                //
            var meNumbers = d3.select('g.column.me').selectAll('text.meNumber').data(dataSet);
            meNumbers.enter()
               .append('text')
               .attr('class', 'meNumber');
            meNumbers.exit()
               .remove();
            meNumbers
            .attr('x', function(d) {return (1-((d.Attend || 100)*0.01)) * columnBand.rangeBand() + 6;  })
            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return 100-(d.Attend)||0});
                
                
                
    //feNumber
        var feNumbers = d3.select('g.column.fe').selectAll('text.feNumber').data(dataSet);
        feNumbers.enter()
            .append('text')
            .attr('class', 'feNumber');
        feNumbers.exit()
            .remove();
        feNumbers
            .attr('x', function(d) {return (1-((d.AttendFemale || 100)*0.01)) * columnBand.rangeBand() + 6;  })
            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return 100-(d.AttendFemale)||0});
       
          
//----------------------------------------Male labour---------------------------------------------                
       
        var mlSel = d3.select('g.column.ml').selectAll('rect.value').data(dataSet);
        mlSel.enter()
            .append('rect')
            .attr('class', 'value');
        mlSel.exit()
            .remove();
        mlSel
            .attr('x', 0)
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
//            .transition()
//            .duration(1000)
            .attr('width', function(d) {return ((d.Labour || 0)*0.01) * columnBand.rangeBand();})
        //문장과 문장이 아닌것의 차이는 뭘까?
            .attr('fill', '#81979f')
            .attr('fill-opacity', '0.75')
                .on("mouseover", function () {
                    d3.select(this).attr("fill-opacity", "1");
                                    })
                .on("mouseout", function () {
                    d3.select(this).attr("fill-opacity", "0.75");
                });
        
                
        //--------------------------------Female labour---------------------------------------
        
         var flSel = d3.select('g.column.fl').selectAll('rect.value').data(dataSet);
        flSel.enter()
            .append('rect')
            .attr('class', 'value');
        flSel.exit()
            .remove();
        flSel
            .attr('x', function(d, i) {return columnBand(i);})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return ((d.LabourFemale || 0) * 0.01) * columnBand.rangeBand();})
        .attr('fill', '#c8887a')
            .attr('fill-opacity', '0.75')
                .on("mouseover", function () {
                    d3.select(this).attr("fill-opacity", "1");
                })
                .on("mouseout", function () {
                    d3.select(this).attr("fill-opacity", "0.75");
                });
       
                //%단위로 꼭 해야하나?
                
        
        //----------------------------------Male edu------------------------------------------
                
                
        var meSel = d3.select('g.column.me').selectAll('rect.value').data(dataSet);
        meSel.enter()
            .append('rect')
            .attr('class', 'value');
        meSel.exit()
            .remove();
        meSel
            .attr('x', function(d, i) {return columnBand(i);})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (1-((d.Attend ||100)*0.01)) * columnBand.rangeBand();})
        .attr('fill','#8ca4ad')
                .attr('fill-opacity', '0.75')
                .on("mouseover", function () {
                    d3.select(this).attr("fill-opacity", "1");
                })
                .on("mouseout", function () {
                    d3.select(this).attr("fill-opacity", "0.75");
                });
        
        
        //-------------------------------------Female edu----------------------------------------
                
                
        var feSel = d3.select('g.column.fe').selectAll('rect.value').data(dataSet);
        feSel.enter()
            .append('rect')
            .attr('class', 'value');
        feSel.exit()
            .remove();
        feSel
            .attr('x', function(d, i) {return columnBand(i);})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (1-((d.AttendFemale || 100)*0.01)) * columnBand.rangeBand();})
        .attr('fill','#c8887a')
                .attr('fill-opacity', '0.75')
                .on("mouseover", function () {
                    d3.select(this).attr("fill-opacity", "1");
                })
                .on("mouseout", function () {
                    d3.select(this).attr("fill-opacity", "0.75");
                });
        };
        
//----------------------------------------Sort-------------------------------------------------
        
//        
//           svg.selectAll('text.theme').enter().on("click", function() {
//                        			   		sortBars();
//        			   });
//                
//                	var sortOrder = false;
//        			
//        			//Define sort function
//        			var sortBars = function() {
//        
//        				//Flip value of sortOrder
//        			   	sortOrder = !sortOrder;
//        
//        				svg.selectAll("rect")
//        				   .sort(function(a, b) {
//        				   		if (sortOrder) {
//        					   		return d3.ascending(a, b);
//        				   		} else {
//        					   		return d3.descending(a, b);
//        				   		}
//        				   	})
//        				   .transition()
//        				   .duration(1000)
//        				   .attr("y", function(d, i) {
//        				   		return yBand(i);
//        				   });
//        
//        			};	
//                      
        
    </script>
</body>

</html>