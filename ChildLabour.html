<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Child labour</title>
    <style>
        @import url(http://fonts.googleapis.com/earlyaccess/nanumgothiccoding.css);
        body{font-family: 'Roboto', sans-serif;}
        #chart {
           position:
                 }
       
          
    </style>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <script src="d3.min.js" type="text/javascript"></script>
</head>

<body>
    <svg id="chart" height="2400" width="900">
    <text x="243" y="58" style="font-size:0.7rem;">age : 5-14 years old
    <tspan x="243" y="73" style="font-size:0.7rem;">data collecting period : 2002-2011</tspan>
    <tspan x="243" y="88" style="font-size:0.7rem;">unit : %</tspan>
  </text>
        
    <text x="571" y="58" style="font-size:0.7rem;">Theoretical Entry Age Average : 7 
    <tspan x="571" y="73" style="font-size:0.7rem;">data collecting period : 2007-2011</tspan>
    <tspan x="571" y="88" style="font-size:0.7rem;">unit : %</tspan>
  </text>
        
        
    </svg>
    
    <script>
        var dataSet = [];
        // labour data
        d3.csv('data/Child_labour.csv', function (err, labour) {
            d3.csv('data/attendance_in_primary_education.csv', function (err, attend) {
                labour.forEach(function (row) {
                    row['Labour'] = +row['Value'];
                });
                var labourMale = labour.filter(function (row) {
                    return row['Subgroup'].startsWith('Male');
                });
                var labourFemale = labour.filter(function (row) {
                    return row['Subgroup'].startsWith('Female');
                });
                attend.forEach(function (row) {
                    row['Attend'] = +row['Value'];
                });
                var attendMale = attend.filter(function (row) {
                    return row['Subgroup'].startsWith('Male');
                });
                var attendFemale = attend.filter(function (row) {
                    return row['Subgroup'].startsWith('Female');
                });
                
                
//----------------------------------------CountryName----------------------------------------    
                
                var mergedDict = {};
                labourMale.forEach(function (row, i) {
                    var key = row['Country'];
                    mergedDict[key] = row;// 여긴 먼가 오른쪽 왼쪽이 바뀐느낌
                    mergedDict[key].LabourFemale = labourFemale[i].Labour;
                });
                attendMale.forEach(function (row, i) {
                    var key = row['Country'];
                    if (!mergedDict[key]) {
                        mergedDict[key] = row;// 교집합으로 하려면 어떻게?
                    }
                    else {
                        mergedDict[key]['Attend'] = row['Attend'];
                    }
                    mergedDict[key].AttendFemale = attendFemale[i].Attend;
                });
                var mergedData = [];
                for (var key in mergedDict) {
                    mergedData.push(mergedDict[key]);
                }
                
                
                //-----------------교집합을 하고 싶을때!!!!!!
                // 그렇지 않은것만 표시해준다 라고 표현하면 됩니다.!
//                mergedData = mergedData.filter(function(d) {
//                    return !(d.Labour === undefined || d.LabourFemale === undefined || d.Attend === undefined || d.AttendFemale === undefined);
//                });
            
                dataSet = mergedData;
                redraw();
            });
        });

//------------------------------------------Draw------------------------------------------
       
            var redraw = function () {
            var MARGIN = {
                START:0
                , TOP: 0
                , LEFT: 230
                , RIGHT: 0
                , BOTTOM: 0
            , }
            var Width = document.querySelector('#chart').clientWidth;
            var Height = document.querySelector('#chart').clientHeight;
                
            
//----------------------------------------column----------------------------------------
                
                
            var columnBand = d3.scale.ordinal()
                .domain(['ml', 'fl', 'me', 'fe'])
                .rangeRoundBands([MARGIN.LEFT, Width - MARGIN.RIGHT], 0.07);
//            var yScale = d3.scale.linear()
//                .domain([0, 100])
//                .range([0, columnBand.rangeBand()]); 이렇게 스케일도 사실은 해줘야 하는것
            var yBand = d3.scale.ordinal()
                .domain(d3.range(dataSet.length))
                .rangeBands([0, Height - MARGIN.TOP - MARGIN.BOTTOM], 0.12, 7.9);
            
            var columnSel = d3.select('#chart').selectAll('g.column').data(columnBand.domain());
            
            columnSel.enter()
                .append('g')
                .attr('class', function (d) {
                return 'column ' + d;
            });
//                .attr('fill', function (d) {
//                return 'rgb(' + (d.length) * 10 + ',30,30)';
//            })
            columnSel.exit().remove();
            
            columnSel.attr('transform', function (d) {
                return 'translate(' + columnBand(d) + ', ' + MARGIN.TOP + ')'; //++의 정체는 무엇인가!!!
            });
                
                
//-------------------------------------------Making-hover---------------------------------------------            
            var numText=['mlNumbers','flNumbers','meNumbers','feNumber']      
    
                
             var yBandSel = d3.select('#chart').selectAll('g.yBand').data(dataSet);  
             yBandSel.enter()
                .append('g')
                .attr('class', function (d) {
                    return 'yband yand-' + d.Country.replace(/ /g, '-');
                }).append('rect')
                    .attr('x', 0)
                    .attr('y', 0)
                    .attr('fill', 'rgba(0, 0, 0, 0.0)')// rect는 g와는 다르게 기본값이 black이므로 기본값을 이렇게 바꿔줘야 합니다. 
                    //yBand.rangeBand()는 수치값이라고 합니다.
                    .attr('height', yBand.rangeBand())
                    .attr('width', Width)
                    .on("mouseover", function (d) {
                        d3.selectAll('.label.label-' + d.Country.replace(/ /g, '-')).attr('font-weight', 'bold');
                        d3.selectAll('.value'+d.Country).attr("fill-opacity", "1");
//                        d3.selectAll('.mlNumber'+d.Country||'.flNumber'+d.Country||'.meNumber'+d.Country||'.feNumber'+d.Country).attr('fill','red');
//                        
                 //selectAll을 하면 안됐는데 select를 하니까 된것. 와이와이와이파이~
                    })
                    .on("mouseout", function (d) {
                        d3.selectAll('.label.label-' + d.Country.replace(/ /g, '-')).attr('font-weight', '200');
                        d3.selectAll('.value'+d.Country).attr("fill-opacity", "0.7");
                    });
                              
             yBandSel.exit().remove();
             yBandSel
             .attr('transform', function (d,i) {
                return 'translate(' + MARGIN.START + ', ' + yBand(i) + ')';
            });
                
                        
            
//---------------------------------------h2------------------------------------------------
                
                
                var themeName = ['Child Labour','','Non Attendance of Primary Education']
                
                                 
                var themeSel = d3.select('#chart').selectAll('text.theme').data(columnBand.domain());
            themeSel.enter()
                .append('text')
                .attr('class', 'theme');
            themeSel.exit()
                .remove();
            themeSel
                .attr('transform', function (d) {
                    return 'translate(' + columnBand(d) + ', '+40+' )';
                })
                .attr('text-anchor', 'start')
                .attr('font-size','1.1rem')
                .attr('font-weight','bold')
                .attr('fill', 'black')
                .text(function(d, i) {return themeName[i];})
                .on("click", function() {
                       sortBars();
        			   });
                
                	var sortOrder = false;
        			var sortBars = function(d) {
        
                    sortOrder = !sortOrder;
        
                    d3.selectAll('.rect.value')
        				   .sort(function(a, b) {
        				   		if (sortOrder) {
        					   		return d3.ascending(a, b);
        				   		} else {
        					   		return d3.descending(a, b);
        				   		}
        				   	})
        				   .transition()
        				   .duration(1000)
        				   .attr("y", function(d, i) {
        				   		return yBand(i);
        				   });        
        			};
                
                
//------------------------------------------average-------------------------------------------               
          var average =[{Country:'world', ml:15, fl:14, me:18, fe:21}]
                
          var labelWorld = d3.select('#chart').selectAll('text.world').data(average);
            labelWorld.enter()
                .append('text')
                .attr('class', 'world');
            labelWorld.exit()
                .remove();
            labelWorld
                .attr('transform', function (d, i) {
                return 'translate(' + MARGIN.LEFT + ', ' +111+ ')';
            }).attr('text-anchor', 'end')
              .attr('font-size','0.8rem')
                .attr('fill', 'black')
                .attr('font-weight','bold')
                .attr('alignment-baseline', 'text-before-edge')
                .text("World");
          
                                
                var mlWorld = d3.select('g.column.ml').selectAll('rect.world').data(average);
        mlWorld.enter()
            .append('rect')
            .attr('class', 'world');
        mlWorld.exit()
            .remove();
        mlWorld
            .attr('x', 0)
            .attr('y', 121-10)
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (d.ml*0.01) * columnBand.rangeBand();})
            .attr('fill', '#6f959a')
            ;
                
                
            
            var flWorld = d3.select('g.column.fl').selectAll('rect.world').data(average);
        flWorld.enter()
            .append('rect')
            .attr('class', 'world');
        flWorld.exit()
            .remove();
        flWorld
            .attr('x', 0)
            .attr('y', 121-10)
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (d.fl*0.01) * columnBand.rangeBand();})
            .attr('fill', '#c57b6d')
            ;
                
                 var meWorld = d3.select('g.column.me').selectAll('rect.world').data(average);
        meWorld.enter()
            .append('rect')
            .attr('class', 'world');
        meWorld.exit()
            .remove();
        meWorld
            .attr('x', 0)
            .attr('y', 121-10)
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (d.fl*0.01) * columnBand.rangeBand();})
            .attr('fill', '#6f959a')
            ;
                
                
                var feWorld = d3.select('g.column.fe').selectAll('rect.world').data(average);
        feWorld.enter()
            .append('rect')
            .attr('class', 'world');
        feWorld.exit()
            .remove();
        feWorld
            .attr('x', 0)
            .attr('y', 121-10)
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (d.fe*0.01) * columnBand.rangeBand();})
            .attr('fill', '#c57b6d')
            ;
                
//-----------------------------------------averageText---------------------------------------
        
        var mlWorldText = d3.select('g.column.ml').selectAll('text.world').data(average);
        mlWorldText.enter()
            .append('text')
            .attr('alignment-baseline', 'text-before-edge')
            .attr('class', 'world');
        mlWorldText.exit()
            .remove();
        mlWorldText
            .attr('x', function(d) {return (d.ml*0.01) * columnBand.rangeBand() + 6;})
            .attr('y', 121-10)
            .attr('font-size','0.7rem')
            .text(function(d) {return d.ml;});
            
        
        var flWorldText = d3.select('g.column.fl').selectAll('text.world').data(average);
                
            flWorldText.enter()
            .append('text')
            .attr('class','world')
            .attr('alignment-baseline', 'text-before-edge');
            flWorldText.exit()
            .remove();
            flWorldText
            .attr('x',function(d){return (d.fl*0.01)*columnBand.rangeBand() + 6;})
            .attr('y',111)
            .attr('font-size','0.7rem')
            .text(function(d){return d.fl;});
                
        var meWorldText = d3.select('g.column.me').selectAll('text.world').data(average);
                meWorldText.enter()
                .append('text')
                .attr('class','world')
                .attr("alignment-baseline","text-before-edge");
                meWorldText.exit()
                .remove();
                meWorldText
                .attr('x',function(d){return (d.me*0.01)*columnBand.rangeBand() + 6;})
                .attr('y', 111)
                .attr('font-size','0.7rem')
                .text(function(d) {return d.me;});
                
                var feWorldText = d3.select('g.column.fe').selectAll('text.world').data(average);
                feWorldText.enter()
                .append('text')
                .attr('class','world')
                .attr("alignment-baseline","text-before-edge");
                feWorldText.exit()
                .remove();
                feWorldText
                .attr('x',function(d){return (d.fe*0.01)*columnBand.rangeBand() + 6;})
                .attr('y', 111)
                
                .attr('font-size','0.7rem')
                .text(function(d) {return d.fe;});
            
                
                
//------------------------------------------Labels--------------------------------------------
                
            var labelSel = d3.select('#chart').selectAll('text.label').data(dataSet);
            labelSel.enter()
                .append('text')
                .attr('class', function(d) {return 'label label-' + d.Country.replace(/ /g, '-');});
                // 숫자 대신에 class에 text.label.label-country 이름이 나오게 바꿔준거에염.
            labelSel.exit()
                .remove();
            labelSel
                .attr('transform', function (d, i) {
                return 'translate(' + MARGIN.LEFT + ', ' + yBand(i) + ')';
            }).attr('text-anchor', 'end')
              .attr('font-size','0.8rem')
                .attr('fill', 'black')
                .attr('alignment-baseline', 'text-before-edge')
                .text(function (d) {
                return d.Country;
            });
                
//==========================================Gragh=================================================              
              var numText=['mlNumbers','flNumbers','meNumbers','feNumber']  
                
                
                
          var mlNumbers = d3.select('g.column.ml').selectAll('text.mlNumber').data(dataSet);
                mlNumbers.enter()
            .append('text')
            .attr('class',function(d){return 'mlNumber'+d.Country;} );
        mlNumbers.exit()
            .remove();
        mlNumbers
            .attr('x', function(d) {
                if(d.Labour !== 0) {
                    return ((d.Labour || 0)*0.01) * columnBand.rangeBand() + 6;
                } else {
                    return 0;
                }
            })
            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return d.Labour||"no data"});
                
                
            //
                var flNumbers = d3.select('g.column.fl').selectAll('text.flNumber').data(dataSet);
                flNumbers.enter()
            .append('text')
            .attr('class', function(d){return 'flNumber'+d.Country;});
        flNumbers.exit()
            .remove();
        flNumbers
            .attr('x', function(d) {
            if(d.LabourFemale !== 0){
                 return ((d.LabourFemale || 0) *0.01) * columnBand.rangeBand() + 6; 
            }  else {
                  return 0;
                  }
            })

            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return d.LabourFemale||"no data"});
                
                
                
                //
            var meNumbers = d3.select('g.column.me').selectAll('text.meNumber').data(dataSet);
            meNumbers.enter()
               .append('text')
               .attr('class', function(d){return 'meNumber'+d.Country;});
            meNumbers.exit()
               .remove();
            meNumbers
            .attr('x', function(d) {
                if(d.Attend) {
                    return ( 1-((d.Attend || 100)*0.01)) * columnBand.rangeBand() + 6;
                } else {
                    return 0;                     
                }
            })
            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return 100-(d.Attend)||0});
                
                
                
    //feNumber
        var feNumbers = d3.select('g.column.fe').selectAll('text.feNumber').data(dataSet);
        feNumbers.enter()
            .append('text')
            .attr('class', function(d){return 'feNumber'+d.Country;});
        feNumbers.exit()
            .remove();
        feNumbers
            .attr('x', function(d) 
                    {if(d.Attend) {
                    return ( 1-((d.Attend || 100)*0.01)) * columnBand.rangeBand() + 6;
                } else {
                    return 0;                     
                }})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('fill','grey')
            .attr('font-size','0.7rem')
            .attr('alignment-baseline', 'text-before-edge')
            .text(function(d) {return 100-(d.AttendFemale)||0});
       
          
//----------------------------------------Male labour---------------------------------------------                
       
        var mlSel = d3.select('g.column.ml').selectAll('rect.value').data(dataSet);
        mlSel.enter()
            .append('rect')
            .attr('class', function(d){return 'value'+d.Country;});
        mlSel.exit()
            .remove();
        mlSel
            .attr('x', 0)
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
//            .transition()
//            .duration(1000)
            .attr('width', function(d) {return ((d.Labour || 0)*0.01) * columnBand.rangeBand();})
            .attr('fill', '#6f959a')
            .attr('fill-opacity', '0.65');
//                .on("mouseover", function () {
//                    d3.select(this).attr("fill-opacity", "1");
//                                    })
//                .on("mouseout", function () {
//                    d3.select(this).attr("fill-opacity", "0.75");
//                });
        
                
        //--------------------------------Female labour---------------------------------------
        
         var flSel = d3.select('g.column.fl').selectAll('rect.value').data(dataSet);
        flSel.enter()
            .append('rect')
            .attr('class', function(d){return 'value'+d.Country;});
        flSel.exit()
            .remove();
        flSel
            .attr('x', function(d, i) {return columnBand(i);})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return ((d.LabourFemale || 0) * 0.01) * columnBand.rangeBand();})
            .attr('fill', '#c57b6d')
            .attr('fill-opacity', '0.65');
//                .on("mouseover", function () {
//                    d3.select(this).attr("fill-opacity", "1");
//                })
//                .on("mouseout", function () {
//                    d3.select(this).attr("fill-opacity", "0.75");
//                });
       
               
                
        
        //----------------------------------Male edu------------------------------------------
                
                
        var meSel = d3.select('g.column.me').selectAll('rect.value').data(dataSet);
        meSel.enter()
            .append('rect')
            .attr('class', function(d){return 'value'+d.Country;});
        meSel.exit()
            .remove();
        meSel
            .attr('x', function(d, i) {return columnBand(i);})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (1-((d.Attend ||100)*0.01)) * columnBand.rangeBand();})
        .attr('fill','#6f959a')
                .attr('fill-opacity', '0.65');
//                .on("mouseover", function () {
//                    d3.select(this).attr("fill-opacity", "1");
//                })
//                .on("mouseout", function () {
//                    d3.select(this).attr("fill-opacity", "0.75");
//                });
//        
        
        //-------------------------------------Female edu----------------------------------------
                
                
        var feSel = d3.select('g.column.fe').selectAll('rect.value').data(dataSet);
        feSel.enter()
            .append('rect')
            .attr('class', function(d){return 'value'+d.Country;});
        feSel.exit()
            .remove();
        feSel
            .attr('x', function(d, i) {return columnBand(i);})
            .attr('y', function(d, i) {return yBand(i);})
            .attr('height', yBand.rangeBand())
            .attr('width', function(d) {return (1-((d.AttendFemale || 100)*0.01)) * columnBand.rangeBand();})
        .attr('fill','#c57b6d')
                    .attr('fill-opacity', '0.65');
//                .on("mouseover", function () {
//                    d3.select(this).attr("fill-opacity", "1");
//                })
//                .on("mouseout", function () {
//                    d3.select(this).attr("fill-opacity", "0.75");
//                });
       
        
          
                      
      };   
    </script>
</body>

</html>