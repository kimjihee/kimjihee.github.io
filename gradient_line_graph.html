<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>C02 Emission</title>
    <style>
       
        body {
            font-family: 'Roboto', sans-serif;
            font-size:0.6rem;
        }
        #chart {position: absolute;
        top:7rem;
        left:8rem;}
        .axis path, .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }
        .unit {font-size:1rem;}
        p{
            font-size:2rem;
            position: absolute;
            top:1rem;
            left:8rem;
        }
        .axis .domain {display:none;}
        .x text {text-anchor:start !important;}
        .tick line{stroke:rgb(240,240,240);}
        .lineCO2 {
          fill: none;
          stroke: url(#temperature-gradient);
          stroke-width: 3px;
        }
         #tooltip {
            position: absolute;
            height: auto;
            padding: 5px;
            background-color: rgb(250,250,250);
            font-size:0.7rem;
            border-radius:2px; 
            font-weight:500;
            color:rgb(55,55,55);
            z-index:1000;
            box-shadow: 5px 6px 12px rgba(100,100,100, 0.6);
            pointer-events: none;
            border: 1.5px solid rgba(107,140,166,0.8);
        }

        #tooltip.hidden {
            display: none;
        }
		.key{
			font-size:0.8rem;
			padding-bottom:0.7rem;
			white-space:nowrap;
		}
		.value{
			color:#6e8da6;
			font-weight:bold;
			padding-right:0.1rem;
		}
      </style>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    
    <script src="d3.min.js" type="text/javascript"></script></head>
    <body>
        <p> CO2 Emission <span class="unit">Tons Per Capita</span></p>
        <svg id="chart" >  <foreignobject class="node" width="100" height="100">
            <div id='tooltip' class="hidden">
               <span class="key"></span> <span class="value"></span>tons
            </div>       
        </foreignobject>
        </svg>
        
        
        
        <script>

//--- Data---------------------------------------------
        var dataSet = [];
        var yearExtent = [];
        var valueExtent = [];
//            tonsPerCapita;
        var Emission = d3.csv('data/CO2emissions.csv', function (err, CO2) {
            CO2.forEach(function (row) {
                row['Country'] = row['Country'];
                row['Value'] = +row['Value']; 
                row['Year'] = new Date(+row['Year'], 0 ,1);
            });
            
            yearExtent = d3.extent(CO2, function(d) {return d.Year;});
            valueExtent = [0, d3.max(CO2, function(d) {return d.Value;})];
            
            var Nest = d3.nest()
            .key(function(d){
                return d.Country;
               
            })
            .entries(CO2);                 
                       
            dataSet = Nest;
            redraw();           
                       
       });     
        
            
        var redraw = function(){
           console.log(dataSet);  
            var Width = 800;
            var Height = 400;
                
            var xScale = d3.time.scale()
                .domain(yearExtent)
                .rangeRound([0, Width]);
            var yScale = d3.scale.linear()
                .domain([0,100])
                .rangeRound([Height,0]);

          var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom')
                .ticks(d3.time.date, 1)//start stop //이렇게 1이 스탑인데 맞나요?
                .tickFormat(d3.time.format('%Y'))
                .tickSize(0)
                .tickPadding(8)
                ;
            

            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left')
                .tickSize(-800)
                .tickPadding(8)
                ; 
            
            
            var svg = d3.select("svg")
                .attr("width",Width+100)
                .attr("height", Height+100);
            
            var realChart = svg
                .append('g')
                .attr("transform", "translate( "+30+" ," + 20 + ")");
                

            realChart.append('g')
                .attr('class', 'x axis')
                .attr("transform", "translate( 0 ," + Height + ")")
                .style('stroke-width','3')
                .call(xAxis);
            
            realChart.append('g')
              .attr('class', 'y axis')
              .call(yAxis);
                      
            var lineCO2 = d3.svg.line()
                .interpolate("basis")   //interpolate는 무엇인가?
                .x(function(d) { return xScale(d.Year); })
                .y(function(d) { return yScale(d.Value); })
                .interpolate("monotone");

            svg.append("linearGradient")
                .attr("id", "temperature-gradient")
                .attr("gradientUnits", "userSpaceOnUse")
                .attr("x1", 0).attr("y1", yScale(50))//y값이 없다고 해서 질문했는데. y()을 쓰려면
                //                                                  어디엔가 y함수가 있어야 한다고 하셨다. 예를들어 yscale()
                .attr("x2", 0).attr("y2",  yScale(60))//여기 40 60이 무엇인지 모름
                .selectAll("stop")
                .data([
                    {offset: "0%", color: "#6e8da6"},
                    {offset: "50%", color: "gray"},
                    {offset: "100%", color: "#f93131" }
                ])
                .enter()
                .append("stop")
                .attr("offset", function(d) { return d.offset; })
                .attr("stop-color", function(d) { return d.color; }); 

            var dataLines = realChart.selectAll('path.lineCO2').data(dataSet);
            dataLines.enter()
                .append("path")
                .attr("class", "lineCO2")
                .style('fill',"none")
                .style('opacity',0.45)
                .style('stroke-width',1.8)
                .on("mouseover", function (d) {
                        var xPosition = parseFloat(d3.select(this).attr("x"));
                        var yPosition = parseFloat(d3.select(this).attr("y"));
                        var coords = d3.mouse(this);
                        var newData= {
                        x: Math.round( xScale.invert(coords[0])),y: Math.round( yScale.invert(coords[1]))
                        };

                        d3.select(this)
                            .style('opacity', 0.9)
                            .style('stroke-width',"2.8px"); 

                        d3.select('#tooltip')
                            .style('opacity', 1)
                            .style('left',coords[0]+30+'px')
                            .style('top',coords[1]+(-20)+'px')
							.classed("hidden", false);
						d3.select('#tooltip .key').text(d.key);
						d3.select('#tooltip .value').text(newData.y);
                    })
                    .on("mouseout",  function () {
                        d3.select(this)
                            .style('opacity', 0.45)
                            .style('stroke-width',"1.8px");
                       d3.select("#tooltip").classed("hidden", true);
                    });
            
            dataLines.exit()
                .remove();
            dataLines
                .attr("d",   function(d){ return lineCO2(d.values);}
                );
            

       };
    
        </script>
</body>
</html>