<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Working Time and Hourly Compensation</title>
  <style>
/*        @import url(http://fonts.googleapis.com/earlyaccess/nanumgothiccoding.css);*/
    body {
    font-family: 'Roboto', sans-serif;
    font-size:0.7rem;
    box-sizing: border-box;
    margin:0;
    }
    .xAxis path,
    .xAxis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
    }
    .yAxis path,
    .yAxis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
    }
    .domain{
    stroke-width:0 !important;
    stroke:rgb(140,140,140);
		
    }
    .tick text{
    fill:rgba(160,160,160,0.9) !important;
    }
    .tick line{
        stroke:rgb(200,200,200);}
    .xAxis text {
        text-anchor:start !important;
		z-index:-100;
		opacity:0;
    }
	P{
    position: absolute;
    top:1vw;
    left:8.7rem;
    font-size:1.5rem;
/*	line-height:2.5rem;*/
    }
    .comP {
    position: absolute;
    top:3vw;
    left:51.5rem;}
    .wRect {
        background-color:#FF8A65;
        position: absolute;
        left:0;
		top:0.5rem;
        opacity: 0.4;
		display: block;
        width:8.5rem;
        height:1rem;
		z-index:-2;
    }
    .hRect {
        background-color:#00897B;
        position: absolute; 
		top:0.5rem;
        left:19rem;
        opacity: 0.25;
		display: block;
        width:14rem;
        height:1rem;
		z-index:-2;
    } 
    #chart {
		display:block;
		margin:0 auto;
/*
        position: absolute;
        left:10rem;
        right:10vw;
*/
    }
	.degree{font-size:1rem;}
    
    </style>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <script src="d3.min.js" type="text/javascript"></script>
</head>

<body>
    <P >Working Time Per Week <span class="wRect"></span>
   &nbsp;&&nbsp; Hourly Compensation <span class="degree">(US$)</span><span class="hRect"></span></P>
    <svg id="chart">
        
    </svg>
   
    <script>
 
        var dataSet = [];
        var valueData = [];
        
        d3.csv('data/hour_compensation.csv', function (err, compensation) {
            d3.csv('data/working_hours_per_week.csv', function (err, work) {
				var myCountries = [
                    'Korea, Rep.','Hong Kong, China','Germany',
                    'Netherlands','Bangladesh','United Kingdom',
                    'United States','Italy','France','Japan',
                    'Sri Lanka','Greece','Norway'
                ];
				compensation = compensation.filter(function(d) {
					return myCountries.indexOf(d.Country) !== -1;
				});
				work = work.filter(function(d) {
					return myCountries.indexOf(d.Country) !== -1;
				});
				console.log(work);
//                var pickCountries = valueData.filter(function (row) {
//                    for(var i = 0; i < myCountries.length; i++) {
//                        if(row['Country'] === myCountries[i]) return true;
//                    }
//                    return false;
//                });    
				
				//이게 왜 0인지 모르겠다.
               	for(var i = 0; i<12; i++) {
//					console.log(compensation.length);
                    var time = compensation[i];
					var wTime = work[i+1];// 임의로 맞춤
                    var country = time['Country'];
                    delete time['Country'];
				 	
					
					for(var year in time, wTime) {
//						for(var year in wTime) {
							valueData.push({
								Country: country,
								Year: +year,
								compenValue: +time[year],
								workTimeValue: +wTime[year]
							});
//						}
					}
//					workTimeValue: for(var i = 0; i<work.length; i++) {
//							var times = work[i];
//
//							for(var year in times) {
//								workTimeValue: 	+times[year]
//							}
//					}
				
                }
				console.log(valueData);				
                yearExtent = d3.extent(valueData, function(d) {return d.Year;});
                valueExtent = d3.extent(valueData, function(d) {return d.workTimeValue;});
        
                dataSet = d3.nest()
                    .key(function(d){
                        return d.Country;
                    })
                    .entries(valueData);
  
				for(var i = 0; i < dataSet.length; i++) {
					var Mean = d3.mean(
						dataSet[i].values.filter(function(d) {return d.compenValue !== 0;}),
						function(d) {return d.compenValue;}
					);
					for(var j = 0; j < dataSet[i].values.length; j++) {
						dataSet[i].values[j].compenValue = dataSet[i].values[j].compenValue || Mean;
					}
            	}
				for(var i = 0; i < dataSet.length; i++) {
					var workMean = d3.mean(
						dataSet[i].values.filter(function(d) {return d.workTimeValue !== 0;}),
						function(d) {return d.workTimeValue;}
					);
					for(var j = 0; j < dataSet[i].values.length; j++) {
						dataSet[i].values[j].workTimeValue = dataSet[i].values[j].workTimeValue || workMean;
					}
            	}
                redraw(); 
              
            });
        });

     var redraw = function () {   

            var MARGIN = {
                START:0
                , TOP: 125
                , LEFT: 20
                , RIGHT: 100
                , BOTTOM: 0
            , }

            var Width = 1100
            ,Height = 500
            ,padding = 60;

            var columnSel = d3.select('#chart')
                .attr("width", Width+100)
                .attr("height", Height+100)
                .selectAll('g.column').data(dataSet);

            columnSel
                .enter()
                .append('g')
                .attr('class', function (d) {
                    return 'column ' + " " + d.key;
                })
                .append('rect')
                .attr('class', function (d) {
                    return 'rect' + d.key;
                })
                .attr('width','126')
                .attr('height','80')
                .attr('y',60)
                .style('fill',"grey")
				.style('opacity',0)
                .style('z-index',"20")
				.attr("transform", "translate(  "+ (padding/2) +" ,0)")
                .on("mousemove", function (d, i) {
                    var coords = d3.mouse(this);
					var year = Math.floor( xScale.invert(coords[0] + (padding/2)));
					var value = dataSet[i].values.filter(function(d) {return d.Year == year})[0];
					d3.select(this.parentNode.querySelector('.compenCircle'))
						.style('opacity', 1)
						.attr('cx', xScale(year))
						.attr('cy', yScale(value.compenValue))
						.style('fill','#00897B');
					d3.select(this.parentNode.querySelector('.compenText'))
						.style('opacity', 1)
						.attr('x', xScale(year)-3)
						.attr('y', yScale(value.compenValue)-7)
						.text(Math.ceil(value.compenValue)+"$");
					d3.select(this.parentNode.querySelector('.workCircle'))
						.style('opacity', 1)
						.attr('cx', xScale(year))
						.attr('cy', yScale(value.workTimeValue))
						.style('fill','#FF8A65');
					d3.select(this.parentNode.querySelector('.workText'))
						.style('opacity', 1)
						.attr('x', xScale(year)-3)
						.attr('y', yScale(value.workTimeValue)-7)
						.text(Math.ceil(value.workTimeValue)+"h");
				})
                .on("mouseout",  function () {
                    d3.select(this.parentNode.querySelector('.compenCircle'))
                    	.style('opacity', 0);
				 	d3.select(this.parentNode.querySelector('.compenText'))
						.style('opacity', 0);
				 	d3.select(this.parentNode.querySelector('.workCircle'))
                    	.style('opacity', 0);
				 	d3.select(this.parentNode.querySelector('.workText'))
						.style('opacity', 0);
				
                });
            
            columnSel.exit().remove();
            columnSel
                .attr('transform', function (d,i) {
                return 'translate(' + ( Math.floor(i%5)* (Width/5) + MARGIN.LEFT )+ ', '+ ((Height/3)* Math.floor(i/5) +  MARGIN.TOP  )+ ')';
                });
 
            var xScale = d3.scale.linear()
                .domain(yearExtent)
                .rangeRound([padding, (Width/5) - padding*1.2]);
            
            var yScale = d3.scale.linear()
                .domain(valueExtent)
                .rangeRound([(Height/3) - padding , padding]);

            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom')
                .tickValues([1980,2006])
                .tickSize(0)
                .tickPadding(10);

            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left')
                .tickValues([0,50])
                .tickSize(0)
                .tickPadding(5);
          
            columnSel
                .append('g')
                .attr('class', 'axis x')
                .attr("transform", "translate(  0," + yScale.range()[0]+ ")")
                .style('stroke-width','2px')
                .call(xAxis)
                .append("text")
                .attr("y", -105)
                .attr("x", 40)
                .attr("dy", "3em") 
                .style("line-height", "-0.8rem")
                .style("font-size", "0.8rem")
                .style('font-weight','bold')
                .style('fill','balck')
                .style('opacity','0.67')
                .text(function (d){return d.key; });
         
            columnSel
                .append('g')
                .attr('class', 'axis y')
                .style("text-anchor", "middle")
				.attr("transform", "translate(  "+ padding +" ,0)")
                .call(yAxis);
                
            var compenLine = d3.svg.line()
                .x(function(d) { return xScale(d.Year); })
                .y(function(d) { return yScale(d.compenValue); })
                .interpolate("monotone");   
		 	
		 	var workLine = d3.svg.line()
                .x(function(d) { return xScale(d.Year); })
                .y(function(d) { return yScale(d.workTimeValue);})
                .interpolate("monotone");    
            
            columnSel
                .append('path')
                .attr('class', function (d) {
                    return 'compenData' + d.key;
                })
                .style('fill',"none")
                .style('z-index',"2")
                .style('stroke', "#00897B")
                .style('opacity',0.8)
                .style('stroke-width',2.5)
                .attr('d', function(d) {
                    return compenLine(d.values);
                });
		 	
		 	columnSel
                .append('path')
                .attr('class', function (d) {
                    return 'workData' + d.key;
                })
                .style('fill',"none")
                .style('z-index',"2")
                .style('stroke', '#FF8A65')
                .style('opacity',0.8)
                .style('stroke-width',2.5)
                .attr('d', function(d) {
                    return workLine(d.values);
                });
                         
            columnSel
                .append('text')
                .attr('class', function (d) {
                    return 'compenText ' + d.key;
                })
				.attr('fill','rgb(170,170,170)');
            columnSel
                .append('circle')
				.attr('class', 'compenCircle')
                .attr('opacity','0')
                .attr('r',3);
		  	columnSel
                .append('text')
                .attr('class', function (d) {
                    return 'workText ' + d.key;
                })
				.attr('fill','rgb(170,170,170)');
            columnSel
                .append('circle')
				.attr('class', 'workCircle')
                .attr('opacity','0')
                .attr('r',3);
         }; 
      
    </script>
    </body>
</html>
