<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>workingTime</title>
    <style>
/*        @import url(http://fonts.googleapis.com/earlyaccess/nanumgothiccoding.css);*/
        body {
            font-family: 'Roboto', sans-serif;
            font-size: 0.4rem;
            margin:0;
            padding:0;
            
        }
        .name {
            font-size:2rem;
            position: absolute;
            left:8rem;
            top:0;
        }
        svg {
            shape-rendering: crispEdges;
          
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        #tooltip {
            position: absolute;
            height: auto;
            padding: 10px;
            background-color: white;
            -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            -moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            }
			
        #tooltip.hidden {
            display: none;
        }

        #tooltip p {
            margin: 0;
            font-family: sans-serif;
            font-size: 0.8rem;	
        }
        #chart {
            position: absolute;
            top:5rem;
            }
        .unit {font-size:1.2rem;}

    </style>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <script src="d3.min.js" type="text/javascript"></script>
</head>

<body>
<!--    <div id="tooltip" class="hidden">-->
       
<!--
        <p><span id="value"></span>time</p>
</div>
-->
    <p class="name">Working Time<span class="unit"> &nbsp;per week</span></p>
    <svg id="chart"> </svg>
    <script>
         
//--------------------------------------Data---------------------------------------------
//             yearExtent = for(var i=1980; i<2008; i++){i}// for을 왜 못쓸까?
//            var pickCountries = time.forEach(function (row) {
//                for(var i = 1980; i < 2008; i++) {
//                    d3.max(time, function (d) {
//                      row[i];
//                     })
//                }
//                });           
//            console.log(pickCountries);
         var dataSet = [];
        var valueData = [];
        var Workingtime = d3.csv('data/working_hours_per_week.csv', function (err, times) {
            for(var i = 0; i < times.length; i++) {
                var time = times[i];
                var country = time['Country'];
                delete time['Country'];
                for(var year in time) {
                    valueData.push({
                        Country: country,
                        Year: +year,
                        Value: +time[year]//여기 다시 물어보기
                    });
                }
              }
            
            dataSet = d3.nest()
                .key(function(d){
                    return d.Country;
                })
                .entries(valueData);
                
                for(i=0; i<dataSet.length; i++){                            
                for(j=0; j<28; j++){
                
                    var Min = d3.min(dataSet[i].values.filter(function(d) {
                        return d.Value !== 0;}), function(d) {return d.Value;}
                                       );
                        if(dataSet[i].values[j].Value===0) {
                                                  
                        dataSet[i].values[j].Value = Min;                      
                                                   
                }}
            }        
            
            redraw();
      
       });

        var redraw = function () {   
//------------------------------------------Draw------------------------------------------
                                 
                    var MARGIN = {
                        START:0
                        , TOP: 50
                        , LEFT: 100
                        , RIGHT: 100
                        , BOTTOM: 0
                    , }
         
                    var Width = 1000;
                    var Height =600;
//-----------------------------------------AddColunm--------------------------------------                 
           var columnSel = d3.select('#chart')
                .attr("width", Width+100)
                .attr("height", Height+500)
                .selectAll('g.column').data(dataSet);

            columnSel.enter()
                .append('g')
                .attr('class', function (d) {
                    return 'column ' + d.key;
                })
               ;
                    
            columnSel.exit().remove();
            columnSel.attr('transform', function (d,i) {
                return 'translate(0,' + (Math.floor(i%52)*(Height/52))+') ';
            });

//------------------------------------------One Graph-------------------------------------                         console.log(yearExtent);
                    var countryNames = dataSet.map(function(d) {return d.key;});
                    var xScale = d3.scale.linear()
                        .domain([1980,2007])//여기는 데이터 전체가 아니라 시작부터 끝.
                        .rangeRound([0, Width]);//라운드랑 밴드랑 먼지모름.
                 
                    var yScale = d3.scale.ordinal()
                        .domain(countryNames)
                        .rangeBands([0,Height],0.1);
                    
                    var colorScale = d3.scale.quantize()
                    .domain([
                        d3.max(valueData, function (d) {
                            return d.Value;
                        }),
                        0
                    ])
                    .range([ 
                        '#e31a1c', '#fc4e2a','#fd8d3c','#feb24c','#fed976','#ffeda0','#ffffcc','white'
//                        '#e60004','#ff4f0c','#ff7d19','#ffa529','#ffd251','#f6f490','white'
]); 
                 
                    console.log(colorScale.domain());// domain은 이렇게 알수 있다.
                    var xAxis = d3.svg.axis()
                        .scale(xScale)
                        .orient('bottom')
                        .tickSize(3)
                        .tickFormat(function (d) {
                         return d;
                         })
                        .tickPadding(2) ;   
                 
                    var yAxis = d3.svg.axis()
                        .scale(yScale)
                        .orient('left')
                        .tickFormat(function(d) {return d;})
                        .tickSize(3);
                      
                    var svg = d3.select("svg")
                        .attr("width",Width+200)
                        .attr("height", Height+40);

                    var realChart = svg
                        .append('g')
                        .attr("transform", "translate( "+130+" ," + 20 + ")");
 
                 realChart.append('g')
                        .attr('class', 'x axis')
                        .attr("transform", "translate( 0 ," + Height + ")")//이건 어떻게 해야할까?
                        .style('stroke-width','0')
                        .call(xAxis)
                        .selectAll('text')
                        .style('text-anchor', 'start');//x축 텍스트 정렬은 이렇게!!

                   realChart.append('g')
                      .attr('class', 'y axis')
                      .style('stroke-width','0')
                      .style('text-anchor','end')// 이게 x축에 적용이 된다.
                      .call(yAxis);
                  
                    var cellHeight = Height/52;
                     var cellWidth = Width/28;       
                 
                                      
                    var rect = columnSel.selectAll(".day")
                        .data(function(d){
                              return d.values;})
                        .enter()
                        .append("rect")
                        .attr("class", function(d){
                              return  "day " + d.Country;})
                         .attr("transform", "translate( " + 130 + " ,"+ 20 +")")
                        .attr("width", cellWidth - 1)
                        .attr("height", cellHeight - 1)
                        .attr("x", function(d,i){
                          return cellWidth*(i%28);})
                        .attr("y", function (d,i) {
                            return Math.floor(i/52)*cellHeight;
                        });
//                        .datum(dateFormat);//이건 머지?
                 
                     rect.style("fill", function (d) {
                                return colorScale(d.Value);})
                     .style('opacity',0.9)
                     .on("mouseover", function(d) {
                  
					d3.select("#tooltip")
				        .attr("x", "inherit")						
						.select("#value")
						.text(d.Value);
			   
					d3.select("#tooltip").classed("hidden", false);

			   })
			   .on("mouseout", function() {
			   
					//Hide the tooltip
					d3.select("#tooltip").classed("hidden", true);
					
			   })
			  ;

                      rect.append("title")
                          .text(function (d,i) {
                    return d.Country+" " + d.Value; +'time'
                });
             };
                 
    </script>
    </body>
</html>
