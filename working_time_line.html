<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>workingTime</title>
    <style>
/*        @import url(http://fonts.googleapis.com/earlyaccess/nanumgothiccoding.css);*/
        body {
            font-family: 'Roboto', sans-serif;
            
        }
        .workChart{
            position: absolute;
            top:5vw;
            left:10vw;
            font-size: 0.4rem;
        }
        P{
            position: absolute;
            top:3vw;
            left:11vw;
            font-size:1.5rem;
        }
        .unit{
            font-size:1rem;
        }
       
        .xAxis path,
        .xAxis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        
        .yAxis path,
        .yAxis line {
            fill: none;
            stroke: #000;
/*            shape-rendering: crispEdges;*/
        }
      
        .domain{
           stroke-width:0;
        }
     
        
        .tick line{stroke:rgba(200,200,200,0.3);}
        
        .xAxis text {
            text-anchor:start !important;
        }
        .tooltip span {
        display:none;
        }
        .tooltip:hover span {
            display:block;
            position:fixed;
            overflow:hidden;
        }
        .workTime {
          fill: none;
          stroke: url(#temperature-gradient);
        }
        #tooltip {
            position: absolute;
            height: auto;
            padding: 5px;
            background-color: rgba(250,250,250,0.8);
            font-size:0.7rem;
            z-index:1000;
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            border: 1px solid rgb(220,220,220);
        }

        #tooltip.hidden {
            display: none;
        }

       
    </style>
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro' rel='stylesheet' type='text/css'>
    <script src="d3.min.js" type="text/javascript"></script>
    </head>

    <body>
    <div id='tooltip' class="hidden">
        <p><span id="value"></span></p>
    </div>
    <p>WORKING TIME<span class="unit">&nbsp;&nbsp;per week</span></p>
    <svg id="chart">
        <foreignobject class="node" width="100" height="100">
            <div id='tooltip' class="hidden">
               
            </div>       
        </foreignobject>
    </svg>
    <script>
         
//--------------------------------------Data---------------------------------------------

        
        var dataSet = [];
        var valueData = [];
        var Workingtime = d3.csv('data/working_hours_per_week.csv', function (err, times) {
            for(var i = 0; i < times.length; i++) {
                var time = times[i];
                var country = time['Country'];
                delete time['Country'];
                for(var year in time) {
                    valueData.push({
                        Country: country,
                        Year: +year,
                        Value: +time[year]
                        });
                   
                }
            
            }
            
////            
//             for(j=0; j<valueData.length; j++) {
//                if(valueData[j].Value === 0){ return  20; }
//            }
//            
//              
//                 valueData.forEach(function (d, i) {
//                    if(d.Value===0){
//                        return d.Value = 20;
//                    } 
//                    
//                });
            
            
            yearExtent = d3.extent(valueData, function(d) {return d.Year;});
            valueExtent = d3.extent(valueData, function(d) {return d.Value;});
                          
            dataSet = d3.nest()
                .key(function(d){
                    return d.Country;
                })
                .entries(valueData);
           
            for(var i = 0; i < dataSet.length; i++) {
                var Mean = d3.mean(
                    dataSet[i].values.filter(function(d) {return d.Value !== 0;}),
                    function(d) {return d.Value;}
                );
                for(var j = 0; j < dataSet[i].values.length; j++) {
                    dataSet[i].values[j].Value = dataSet[i].values[j].Value || Mean;
                }
            }
                     
           redraw();                        
//          values 와 Value의 차이  
            
       });
        
  
        
             var redraw = function () {   
//------------------------------------------Draw------------------------------------------
                                 
                    var MARGIN = {
                        START:0
                        , TOP: 50
                        , LEFT: 100
                        , RIGHT: 100
                        , BOTTOM: 0
                    , }
         
                    var Width = 800;
                    var Height =300;

                 /*
                 <g>
                    <path .. />
                    <text .. />
                 </g>
                 <g>
                    <path .. />
                    <text .. />
                 </g>
                 <g>
                    <path .. />
                    <text .. />
                 </g>
                 <g>
                    <path .. />
                    <text .. />
                 </g>
                 */
//------------------------------------------One Graph-------------------------------------                         console.log(yearExtent);

        var xScale = d3.scale.linear()
            .domain([1980,2007])//여기는 데이터 전체가 아니라 시작부터 끝.
            .rangeRound([0, Width]);//라운드랑 밴드랑 먼지모름.

        var yScale = d3.scale.linear()
            .domain(valueExtent)
            .rangeRound([Height,0]);

        var xAxis = d3.svg.axis()
            .scale(xScale)
            .orient('bottom')
            .tickFormat(function (d) {
                return d;
            })
            .tickSize(-250)
            .tickPadding(13);

        var yAxis = d3.svg.axis()
            .scale(yScale)
            .orient('left')
            .tickSize(0)
            .tickPadding(-5);

        var svg = d3.select("svg")
            .attr("width",Width+150)
            .attr("height", Height+80)
            .attr('class','workChart');

        var realChart = svg
            .append('g')
            .attr("transform", "translate( "+40+" ,"+ 60 +")");

        realChart.append('g')
            .attr('class', 'xAxis')
            .attr("transform", "translate( 0 ," + Height + ")")
            .call(xAxis)
            .append('path')
            .attr('d','M 0 0 H 800' )//path 그리기 // 하지만 질문하기
            .style('stroke','rgba(200,200,200,0.3)')
            .style('stroke-width','2');        

        realChart.append('g')
            .attr('class', 'yAxis')
            .attr('stroke-width','0')
            .attr("transform", "translate( "+-20+" ," + 0 + ")")
            .call(yAxis);           

        var time = d3.svg.line()
            .x(function(d) { return xScale(d.Year); })
            .y(function(d) { return yScale(d.Value); })
            .interpolate("monotone");                

        svg.append("linearGradient")
            .attr("id", "temperature-gradient")
            .attr("gradientUnits", "userSpaceOnUse")
            .attr("x1", 0)
            .attr("y1", yScale(35))
            .attr("x2", 0)
            .attr("y2",  yScale(55))
            .selectAll("stop")
            .data([
                {offset: "0%", color: "rgb(255,180,0)"},
                {offset: "50%", color: "#ff7600"},
                {offset: "100%", color: "red"}
            ])
            .enter()
            .append("stop")
            .attr("offset", function(d) { 
                return d.offset; 
            })
            .attr("stop-color", function(d) { 
                return d.color; 
            });  


        var Together = realChart.selectAll('g.data').data(dataSet);

        Together.enter()
            .append('g')
            .attr('class', 'data')
            .each(function(d, i) {
                var group = d3.select(this);

            group.append("path")
                .attr("class", "workTime")
                .style('fill',"none")
                .style('opacity', 0.4)
                .style('stroke-width',"1.5px")
                .attr("d",   function(d){
                    return time(d.values);
                })
                .on("mouseover", function (d) {
                    var xPosition = parseFloat(d3.select(this).attr("x"));
                    var yPosition = parseFloat(d3.select(this).attr("y"));
                    var coords = d3.mouse(this);
                    var newData= {
                    x: Math.round( xScale.invert(coords[0])),y: Math.round( yScale.invert(coords[1]))
                    };

                    d3.select(this)
                        .style('opacity', 2)
                        .style('stroke-width',"2.8px"); 

                    d3.select('#tooltip')
                        .style('opacity', 1)
                        .style('left',coords[0]+130+'px')
                        .style('top',coords[1]+80+'px')
                        .text(d.key+" "+newData.y+"times");
                    d3.select("#tooltip").classed("hidden", false);
                })
                .on("mouseout",  function () {
                    d3.select(this)
                        .style('opacity', 0.4)
                        .style('stroke-width',"1.5px");
                   d3.select("#tooltip").classed("hidden", true);
                });

    
            });
                
//           
//                var voronoi = d3.voronoi()
//                    .x(function(d) { return xScale(d.Year); })
//                    .y(function(d) { return yScale(d.Value); })
//                    .extent([[-MARGIN.LEFT, -MARGIN.TOP], [Width + MARGIN.RIGHT, Height + MARGIN.BOTTOM]]);
//
//                var voronoiGroup = Together.append("g")
//                    .attr("class", "voronoi");
//
//                voronoiGroup.selectAll("path")
//                    .data(voronoi.polygons(d3.merge(data.map(function(d) { return d.values; }))))
//                    .enter().append("path")
//                    .attr("d", function(d) { return d ? "M" + d.join("L") + "Z" : null; })
//                    .on("mouseover", mouseover)
//                    .on("mouseout", mouseout);
//
//                d3.select("#show-voronoi")
//                    .property("disabled", false)
//                    .on("change", function() { voronoiGroup.classed("voronoi--show", this.checked); });  


             };
                 
    </script>
    </body>
</html>

